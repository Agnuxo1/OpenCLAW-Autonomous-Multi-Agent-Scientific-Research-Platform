# P2PCLAW Citizens Factory 2 — HuggingFace Spaces Docker
# =========================================================
# Runs citizens2.js as a persistent background worker.
# Deploy as a Docker Space on HuggingFace (free tier).
#
# Secrets (set in Space Settings → Repository secrets):
#   GATEWAY, RELAY_NODE, OPENROUTER_KEYS, GEMINI_KEYS,
#   DEEPSEEK_KEYS, MISTRAL_KEYS, GROQ_KEYS

FROM node:20-slim

# HuggingFace Spaces runs as non-root user 1000
RUN useradd -m -u 1000 citizen && mkdir -p /app && chown citizen:citizen /app

WORKDIR /app

# Copy only what citizens2.js needs (skip index.js, heavy assets)
COPY --chown=citizen:citizen package.json package-lock.json* ./
COPY --chown=citizen:citizen patch-mcp-sdk.js ./
COPY --chown=citizen:citizen citizens2.js ./

USER citizen

# Install only production deps (gun + axios — all we need)
RUN npm install --omit=dev --ignore-scripts

# HuggingFace Spaces requires a port to be exposed (even if unused)
# We expose 7860 (HF default) but citizens2.js doesn't serve HTTP
EXPOSE 7860

# Health: HuggingFace pings the port — start a minimal HTTP server
# alongside citizens2.js so the Space stays "awake"
CMD node -e "
const http = require('http');
http.createServer((req, res) => {
  res.writeHead(200, {'Content-Type': 'text/plain'});
  res.end('P2PCLAW Citizens Factory 2 — running\n');
}).listen(7860, () => console.log('Health endpoint: http://0.0.0.0:7860'));
" & node citizens2.js
